{% extends "base.html" %}
{% load i18n %}

{% block title %}{% if show_search_form %}{% trans "Stock Information Search" %}{% else %}{{ symbol }}{% if instrument %} - {{ instrument.name }}{% endif %}{% endif %} - shans.ai{% endblock %}

{% block meta_description %}{% if show_search_form %}{% trans "Search for stock information and analysis. Enter a symbol to view detailed metrics, fundamentals, and performance data." %}{% else %}{% trans "Detailed analysis of" %} {{ symbol }}{% if instrument %} ({{ instrument.name }}){% endif %}. {% trans "View key metrics, fundamentals, and performance data." %}{% endif %}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        {% if show_search_form %}
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">{% trans "Stock Information Search" %}</h4>
                </div>
                <div class="card-body">
                    <p class="text-muted">{% trans "Enter a stock symbol to view detailed information, metrics, and analysis." %}</p>
                    <form method="get" action="{% url 'markets:info' %}">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <input type="text" 
                                           class="form-control" 
                                           name="symbol" 
                                           placeholder="{% trans 'Enter stock symbol (e.g., AAPL, MSFT, GOOGL)' %}"
                                           value="{{ symbol }}"
                                           required>
                                    <button class="btn btn-primary" type="submit">
                                        <i class="fas fa-search me-2"></i>{% trans "Search" %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div class="mt-3">
                        <h6>{% trans "Popular Symbols:" %}</h6>
                        <div class="d-flex flex-wrap gap-2">
                            <a href="{% url 'markets:info_symbol' symbol='AAPL' %}" class="btn btn-outline-secondary btn-sm">AAPL</a>
                            <a href="{% url 'markets:info_symbol' symbol='MSFT' %}" class="btn btn-outline-secondary btn-sm">MSFT</a>
                            <a href="{% url 'markets:info_symbol' symbol='GOOGL' %}" class="btn btn-outline-secondary btn-sm">GOOGL</a>
                            <a href="{% url 'markets:info_symbol' symbol='TSLA' %}" class="btn btn-outline-secondary btn-sm">TSLA</a>
                            <a href="{% url 'markets:info_symbol' symbol='AMZN' %}" class="btn btn-outline-secondary btn-sm">AMZN</a>
                            <a href="{% url 'markets:info_symbol' symbol='META' %}" class="btn btn-outline-secondary btn-sm">META</a>
                        </div>
                    </div>
                </div>
            </div>
        {% elif error %}
            <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading">{% trans "Configuration Required" %}</h4>
                <p>{{ error }}</p>
                <hr>
                <p class="mb-0">
                    {% trans "To enable market data features, please:" %}
                    <ol>
                        <li>{% trans "Get a free API key from" %} <a href="https://financialmodelingprep.com/developer/docs" target="_blank">Financial Modeling Prep</a></li>
                        <li>{% trans "Set the FMP_API_KEY environment variable" %}</li>
                        <li>{% trans "Restart the application" %}</li>
                    </ol>
                </p>
            </div>
        {% else %}
        <h1 class="mb-4">
            {{ symbol }} - {{ instrument.name }}
            {% if instrument.exchange %}
                <small class="text-muted">({{ instrument.exchange }})</small>
            {% endif %}
        </h1>
        
        <!-- Company Information -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-building me-2"></i>{% trans "Company Information" %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>{% trans "Sector" %}:</strong> {{ instrument.sector|default:"N/A" }}</p>
                                <p><strong>{% trans "Industry" %}:</strong> {{ instrument.industry|default:"N/A" }}</p>
                                <p><strong>{% trans "Currency" %}:</strong> {{ instrument.currency }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>{% trans "Market Cap" %}:</strong> 
                                    {{ instrument.market_cap_formatted|default:"N/A" }}
                                </p>
                                <p><strong>{% trans "Status" %}:</strong> 
                                    <span class="badge bg-{% if instrument.is_active %}success{% else %}danger{% endif %}">
                                        {% if instrument.is_active %}{% trans "Active" %}{% else %}{% trans "Inactive" %}{% endif %}
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>{% trans "Quick Actions" %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="{% url 'markets:compare' %}?symbols={{ symbol }}" class="btn btn-primary">
                                <i class="fas fa-balance-scale me-2"></i>{% trans "Compare" %}
                            </a>
                            <a href="{% url 'portfolio:form' %}" class="btn btn-success">
                                <i class="fas fa-plus me-2"></i>{% trans "Add to Portfolio" %}
                            </a>
                            {% if user.is_authenticated %}
                                <button class="btn btn-outline-secondary" onclick="saveSymbol('{{ symbol }}')">
                                    <i class="fas fa-bookmark me-2"></i>{% trans "Save" %}
                                </button>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Performance Metrics -->
        {% if metrics %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>{% trans "Performance Metrics" %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-primary">{{ metrics.cagr|floatformat:2 }}%</h4>
                                    <p class="text-muted">{% trans "CAGR (5Y)" %}</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-info">{{ metrics.volatility|floatformat:2 }}%</h4>
                                    <p class="text-muted">{% trans "Volatility" %}</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-success">{{ metrics.sharpe_ratio|floatformat:2 }}</h4>
                                    <p class="text-muted">{% trans "Sharpe Ratio" %}</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-warning">{{ metrics.max_drawdown|floatformat:2 }}%</h4>
                                    <p class="text-muted">{% trans "Max Drawdown" %}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Fundamentals -->
        {% if fundamentals %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-calculator me-2"></i>{% trans "Fundamental Metrics" %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2">
                                <div class="text-center">
                                    <h6>{{ fundamentals.pe_ratio|floatformat:2|default:"N/A" }}</h6>
                                    <p class="text-muted">{% trans "P/E Ratio" %}</p>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center">
                                    <h6>{{ fundamentals.pb_ratio|floatformat:2|default:"N/A" }}</h6>
                                    <p class="text-muted">{% trans "P/B Ratio" %}</p>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center">
                                    <h6>{{ fundamentals.debt_to_equity|floatformat:2|default:"N/A" }}</h6>
                                    <p class="text-muted">{% trans "Debt/Equity" %}</p>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center">
                                    <h6>{{ fundamentals.roe|floatformat:2|default:"N/A" }}</h6>
                                    <p class="text-muted">{% trans "ROE" %}</p>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center">
                                    <h6>{{ fundamentals.roa|floatformat:2|default:"N/A" }}</h6>
                                    <p class="text-muted">{% trans "ROA" %}</p>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center">
                                    <h6>{{ fundamentals.current_ratio|floatformat:2|default:"N/A" }}</h6>
                                    <p class="text-muted">{% trans "Current Ratio" %}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Price Chart -->
        {% if prices %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>{% trans "Price Chart" %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div style="height: 400px;">
                            <canvas id="priceChart"></canvas>
                        </div>
                        {% if prices|length == 0 %}
                            <p class="text-muted text-center mt-3">{% trans "No price data available" %}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    {% trans "Price data is not available for this symbol. This could be due to:" %}
                    <ul class="mb-0 mt-2">
                        <li>{% trans "Symbol not found in the database" %}</li>
                        <li>{% trans "No price data loaded for this instrument" %}</li>
                        <li>{% trans "API key not configured" %}</li>
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Price Table -->
        {% if prices %}
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-table me-2"></i>{% trans "Recent Prices" %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>{% trans "Date" %}</th>
                                        <th>{% trans "Open" %}</th>
                                        <th>{% trans "High" %}</th>
                                        <th>{% trans "Low" %}</th>
                                        <th>{% trans "Close" %}</th>
                                        <th>{% trans "Volume" %}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for price in prices|slice:":20" %}
                                    <tr>
                                        <td>{{ price.date|date:"M j, Y" }}</td>
                                        <td>{{ price.open_price_formatted }}</td>
                                        <td>{{ price.high_price_formatted }}</td>
                                        <td>{{ price.low_price_formatted }}</td>
                                        <td>{{ price.close_price_formatted }}</td>
                                        <td>{{ price.volume|floatformat:0 }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if prices %}
<script>
// Price Chart Data
const priceData = [
{% for price in prices|slice:":50" %}
    {
        x: '{{ price.date|date:"Y-m-d" }}',
        y: {{ price.close_price|floatformat:2 }}
    }{% if not forloop.last %},{% endif %}
{% endfor %}
].reverse();

// Currency symbol for chart formatting
const currencySymbol = '{{ instrument.currency_symbol }}';

// Initialize chart function
function initializeChart() {
    if (priceData.length === 0) {
        document.getElementById('priceChart').innerHTML = '<p class="text-center text-muted">{% trans "No price data available" %}</p>';
        return;
    }

    const ctx = document.getElementById('priceChart').getContext('2d');
    
    // Ensure Chart.js is loaded and we have data
    if (typeof Chart !== 'undefined' && priceData.length > 0) {
        try {
            new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: '{{ symbol }}',
                        data: priceData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1,
                        fill: true,
                        pointRadius: 2,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'day',
                                displayFormats: {
                                    day: 'MMM dd'
                                }
                            },
                            title: {
                                display: true,
                                text: '{% trans "Date" %}'
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: '{% trans "Price" %} ({{ instrument.currency_symbol }})'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return '{{ symbol }}: ' + currencySymbol + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            document.getElementById('priceChart').innerHTML = '<p class="text-center text-danger">{% trans "Chart creation failed" %}</p>';
        }
    } else {
        if (typeof Chart === 'undefined') {
            document.getElementById('priceChart').innerHTML = '<p class="text-center text-muted">{% trans "Chart library not loaded" %}</p>';
        }
    }
}

// Initialize chart when page is loaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeChart);
} else {
    initializeChart();
}
</script>
{% endif %}

{% if user.is_authenticated %}
<script>
function saveSymbol(symbol) {
    // Implementation for saving symbol to user's saved sets
    alert('{% trans "Symbol saved to your collection!" %}');
}
</script>
{% endif %}
    </div>
</div>
{% endblock %}