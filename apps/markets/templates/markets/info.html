{% extends "base.html" %}
{% load i18n %}
{% load markets_extras %}

{% block title %}{% if show_search_form %}{% trans "Stock Information Search" %}{% else %}{{ symbol }}{% if instrument %} - {{ instrument.name }}{% endif %}{% endif %} - shans.ai{% endblock %}

{% block meta_description %}{% if show_search_form %}{% trans "Search for stock information and analysis. Enter a symbol to view detailed metrics, fundamentals, and performance data." %}{% else %}{% trans "Detailed analysis of" %} {{ symbol }}{% if instrument %} ({{ instrument.name }}){% endif %}. {% trans "View key metrics, fundamentals, and performance data." %}{% endif %}{% endblock %}

{% block content %}

<div class="row">
    <div class="col-12">
        {% if show_search_form %}
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">{% trans "Stock Information Search" %}</h4>
                </div>
                <div class="card-body">
                    <p class="text-muted">{% trans "Search for stocks, ETFs, and commodities by symbol, company name, ISIN, ETF name, or commodity symbol to view detailed information, metrics, and analysis. Powered by Financial Modeling Prep API." %}</p>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>{% trans "Search Tips:" %}</strong>
                        <ul class="mb-0 mt-2">
                            <li>{% trans "Symbol search works best (e.g., AAPL, MSFT, GOOGL)" %}</li>
                            <li>{% trans "Company name search works for full names (e.g., 'Gazprom', 'Apple Inc')" %}</li>
                            <li>{% trans "ISIN search works for international securities" %}</li>
                            <li>{% trans "ETF search works for ETF symbols and names (e.g., SPY, VTI, QQQ)" %}</li>
                            <li>{% trans "Commodity search works for commodity symbols (e.g., GCUSD, SILUSD, CLUSD)" %}</li>
                            <li>{% trans "Cryptocurrency search works for crypto symbols (e.g., BTCUSD, ETHUSD, ADAUSD)" %}</li>
                            <li>{% trans "Forex search works for currency pairs (e.g., EURUSD, GBPUSD, USDJPY)" %}</li>
                        </ul>
                    </div>
                    <form method="get" action="{% url 'markets:info' %}">
                        <div class="row">
                            <div class="col-md-8">
                                <div class="input-group">
                                    <select class="form-select" name="search_type" style="max-width: 120px;">
                                        <option value="symbol" {% if search_type == 'symbol' or not search_type %}selected{% endif %}>{% trans "Symbol" %}</option>
                                        <option value="company" {% if search_type == 'company' %}selected{% endif %}>{% trans "Company" %}</option>
                                        <option value="isin" {% if search_type == 'isin' %}selected{% endif %}>{% trans "ISIN" %}</option>
                                        <option value="etf" {% if search_type == 'etf' %}selected{% endif %}>{% trans "ETF" %}</option>
                                        <option value="commodity" {% if search_type == 'commodity' %}selected{% endif %}>{% trans "Commodity" %}</option>
                                        <option value="cryptocurrency" {% if search_type == 'cryptocurrency' %}selected{% endif %}>{% trans "Cryptocurrency" %}</option>
                                        <option value="forex" {% if search_type == 'forex' %}selected{% endif %}>{% trans "Forex" %}</option>
                                    </select>
                                    <input type="text" 
                                           class="form-control" 
                                           name="query" 
                                           id="search-input"
                                           placeholder="{% trans 'Enter search term...' %}"
                                           value="{{ query }}"
                                           required>
                                    <button class="btn btn-primary" type="submit">
                                        <i class="fas fa-search me-2"></i>{% trans "Search" %}
                                    </button>
                                </div>
                                <div class="form-text mt-2">
                                    <small class="text-muted">
                                        <strong>{% trans "Examples:" %}</strong><br>
                                        <span id="search-examples">
                                            <span class="symbol-example">{% trans "Symbol:" %} AAPL, MSFT, GOOGL, TSLA</span><br>
                                            <span class="company-example" style="display: none;">{% trans "Company:" %} Gazprom, Apple Inc, Microsoft</span><br>
                                            <span class="isin-example" style="display: none;">{% trans "ISIN:" %} US0378331005 (Apple), US5949181045 (Microsoft)</span><br>
                                            <span class="etf-example" style="display: none;">{% trans "ETF:" %} SPY, VTI, QQQ, ARKK</span><br>
                                            <span class="commodity-example" style="display: none;">{% trans "Commodity:" %} GCUSD (Gold), SILUSD (Silver), CLUSD (Crude Oil), HGUSD (Copper)</span>
                                            <span class="cryptocurrency-example" style="display: none;">{% trans "Cryptocurrency:" %} BTCUSD (Bitcoin), ETHUSD (Ethereum), ADAUSD (Cardano), SOLUSD (Solana)</span>
                                            <span class="forex-example" style="display: none;">{% trans "Forex:" %} EURUSD (Euro/USD), GBPUSD (Pound/USD), USDJPY (USD/Yen), AUDUSD (Aussie/USD)</span>
                                        </span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    </form>
                    <div class="mt-3">
                        <h6>{% trans "Popular Symbols:" %}</h6>
                        <div class="d-flex flex-wrap gap-2">
                            <a href="{% url 'markets:stock_info' symbol='AAPL' %}" class="btn btn-outline-secondary btn-sm">AAPL</a>
                            <a href="{% url 'markets:stock_info' symbol='MSFT' %}" class="btn btn-outline-secondary btn-sm">MSFT</a>
                            <a href="{% url 'markets:stock_info' symbol='GOOGL' %}" class="btn btn-outline-secondary btn-sm">GOOGL</a>
                            <a href="{% url 'markets:stock_info' symbol='TSLA' %}" class="btn btn-outline-secondary btn-sm">TSLA</a>
                            <a href="{% url 'markets:stock_info' symbol='AMZN' %}" class="btn btn-outline-secondary btn-sm">AMZN</a>
                            <a href="{% url 'markets:stock_info' symbol='META' %}" class="btn btn-outline-secondary btn-sm">META</a>
                            <a href="{% url 'markets:commodity_info' symbol='GCUSD' %}" class="btn btn-outline-warning btn-sm">GCUSD</a>
                            <a href="{% url 'markets:commodity_info' symbol='SILUSD' %}" class="btn btn-outline-secondary btn-sm">SILUSD</a>
                            <a href="{% url 'markets:commodity_info' symbol='CLUSD' %}" class="btn btn-outline-dark btn-sm">CLUSD</a>
                            <a href="{% url 'markets:crypto_info' symbol='BTCUSD' %}" class="btn btn-outline-warning btn-sm">BTCUSD</a>
                            <a href="{% url 'markets:crypto_info' symbol='ETHUSD' %}" class="btn btn-outline-info btn-sm">ETHUSD</a>
                        </div>
                    </div>
                    
                    <!-- JavaScript for Search Type Examples -->
                    <script>
                    document.addEventListener('DOMContentLoaded', function() {
                        const searchTypeSelect = document.querySelector('select[name="search_type"]');
                        const searchExamples = document.getElementById('search-examples');
                        
                        if (searchTypeSelect && searchExamples) {
                            function showExamples() {
                                const selectedType = searchTypeSelect.value;
                                const examples = searchExamples.querySelectorAll('.symbol-example, .company-example, .isin-example, .etf-example, .commodity-example, .cryptocurrency-example, .forex-example');
                                
                                // Hide all examples
                                examples.forEach(example => {
                                    example.style.display = 'none';
                                });
                                
                                // Show selected type example
                                const selectedExample = searchExamples.querySelector('.' + selectedType + '-example');
                                if (selectedExample) {
                                    selectedExample.style.display = 'block';
                                }
                            }
                            
                            searchTypeSelect.addEventListener('change', showExamples);
                            showExamples(); // Show initial example
                        }
                    });
                    </script>
                </div>
            </div>
            
            <!-- Search Results -->
            {% if search_results %}
            <div class="card mt-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-search me-2"></i>{% trans "Search Results" %}
                        <small class="text-muted">({% if search_type == 'symbol' %}{% trans "Symbol" %}{% elif search_type == 'company' %}{% trans "Company Name" %}{% elif search_type == 'isin' %}{% trans "ISIN" %}{% elif search_type == 'etf' %}{% trans "ETF" %}{% elif search_type == 'commodity' %}{% trans "Commodity" %}{% endif %}: "{{ query }}")</small>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for result in search_results %}
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card h-100">
                                <div class="card-body">
                                    <h6 class="card-title">
                                        <a href="{% asset_info_url result.symbol %}" class="text-decoration-none">
                                            {{ result.symbol }}
                                        </a>
                                    </h6>
                                    <p class="card-text">
                                        <strong>{{ result.name }}</strong><br>
                                        {% if result.exchange %}
                                            <small class="text-muted">{{ result.exchange }}</small><br>
                                        {% endif %}
                                        {% if result.currency %}
                                            <small class="text-muted">{{ result.currency }}</small>
                                        {% endif %}
                                        {% if result.marketCap %}
                                            <br><small class="text-success">Market Cap: ${{ result.marketCap|floatformat:0 }}</small>
                                        {% endif %}
                                        {% if result.isin %}
                                            <br><small class="text-info">ISIN: {{ result.isin }}</small>
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="card-footer">
                                    <a href="{% asset_info_url result.symbol %}" class="btn btn-primary btn-sm">
                                        <i class="fas fa-chart-line me-1"></i>{% trans "View Details" %}
                                    </a>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endif %}
            
            <!-- No Results Message -->
            {% if no_results %}
            <div class="card mt-4">
                <div class="card-body text-center">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5>{% trans "No Results Found" %}</h5>
                    <p class="text-muted">
                        {% trans "No stocks found for" %} 
                        {% if search_type == 'symbol' %}{% trans "symbol" %}{% elif search_type == 'company' %}{% trans "company name" %}{% elif search_type == 'isin' %}{% trans "ISIN" %}{% elif search_type == 'etf' %}{% trans "ETF" %}{% endif %}: 
                        <strong>"{{ query }}"</strong>
                    </p>
                    <p class="text-muted">
                        {% trans "Please try:" %}
                        <ul class="list-unstyled mt-2">
                            <li>{% trans "Check your spelling" %}</li>
                            <li>{% trans "Try a different search term" %}</li>
                            <li>{% trans "Use a different search type" %}</li>
                        </ul>
                    </p>
                </div>
            </div>
            {% endif %}
            
            <!-- Search Error Message -->
            {% if search_error %}
            <div class="alert alert-danger mt-4" role="alert">
                <h4 class="alert-heading">{% trans "Search Error" %}</h4>
                <p>{{ search_error }}</p>
            </div>
            {% endif %}
        {% elif error %}
            <div class="alert alert-warning" role="alert">
                <h4 class="alert-heading">{% trans "Configuration Required" %}</h4>
                <p>{{ error }}</p>
                <hr>
                <p class="mb-0">
                    {% trans "To enable market data features, please:" %}
                    <ol>
                        <li>{% trans "Get a free API key from" %} <a href="https://financialmodelingprep.com/developer/docs" target="_blank">Financial Modeling Prep</a></li>
                        <li>{% trans "Set the FMP_API_KEY environment variable" %}</li>
                        <li>{% trans "Restart the application" %}</li>
                    </ol>
                </p>
            </div>
        {% elif is_commodity and quote %}
        <!-- Commodity Information Display -->
        <h1 class="mb-4">
            {{ symbol }} - {{ quote.name|default:symbol }}
            <span class="badge bg-warning text-dark ms-2">Commodity</span>
        </h1>
        
        <!-- Commodity Information -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>{% trans "Commodity Information" %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>{% trans "Symbol" %}:</strong> {{ symbol }}</p>
                                <p><strong>{% trans "Name" %}:</strong> {{ quote.name|default:symbol }}</p>
                                <p><strong>{% trans "Exchange" %}:</strong> {{ quote.exchange|default:"Commodity Exchange" }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>{% trans "Currency" %}:</strong> USD</p>
                                <p><strong>{% trans "Type" %}:</strong> {% trans "Commodity" %}</p>
                                {% if quote.marketCap %}
                                <p><strong>{% trans "Market Cap" %}:</strong> ${{ quote.marketCap|floatformat:0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>{% trans "Quick Actions" %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="{% url 'compare_symbols' symbols=symbol %}" class="btn btn-primary">
                                <i class="fas fa-balance-scale me-2"></i>{% trans "Compare" %}
                            </a>
                            <a href="{% url 'portfolio:form' %}" class="btn btn-success">
                                <i class="fas fa-plus me-2"></i>{% trans "Add to Portfolio" %}
                            </a>
                            {% if user.is_authenticated %}
                                <button class="btn btn-outline-secondary" onclick="saveSymbol('{{ symbol }}')">
                                    <i class="fas fa-bookmark me-2"></i>{% trans "Save" %}
                                </button>
                            {% endif %}
                            <button class="ai-summary-btn btn btn-warning text-dark" data-symbol="{{ symbol }}">
                                <i class="fas fa-robot me-2"></i>{% trans "AI Summary" %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        

        <!-- Price Chart -->
        {% if prices and is_commodity %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>{% trans "Price Chart" %} ({{ currency_symbol }})
                        </h5>
                        <!-- Period Switch -->
                        <div class="btn-group" role="group" aria-label="{% trans 'Chart Period' %}">
                            <input type="radio" class="btn-check" name="chartPeriod" id="period1M" value="1M" {% if period == '1M' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period1M">1M</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period3M" value="3M" {% if period == '3M' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period3M">3M</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period6M" value="6M" {% if period == '6M' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period6M">6M</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="periodYTD" value="YTD" {% if period == 'YTD' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="periodYTD">YTD</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period1Y" value="1Y" {% if period == '1Y' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period1Y">1Y</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period3Y" value="3Y" {% if period == '3Y' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period3Y">3Y</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period5Y" value="5Y" {% if period == '5Y' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period5Y">5Y</label>
                            
                                <input type="radio" class="btn-check" name="chartPeriod" id="period10Y" value="10Y" {% if period == '10Y' %}checked{% endif %}>
                                <label class="btn btn-outline-secondary btn-sm" for="period10Y">10Y</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div style="height: 400px;">
                            <canvas id="commodityPriceChart"></canvas>
                        </div>
                        {% if prices|length == 0 %}
                            <p class="text-muted text-center mt-3">{% trans "No price data available" %}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    {% trans "Price data is not available for this commodity. This could be due to:" %}
                    <ul class="mb-0 mt-2">
                        <li>{% trans "Commodity symbol not found in the database" %}</li>
                        <li>{% trans "No price data loaded for this commodity" %}</li>
                        <li>{% trans "API key not configured" %}</li>
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- AI Summary Result Placeholder - Always render -->
        <div id="ai-summary-card-commodity" class="row" style="display:none;">
            <div class="col-12">
                <div class="card mt-3">
                    <div class="card-header d-flex align-items-center">
                        <i class="fas fa-robot me-2"></i>
                        <h5 class="mb-0">{% trans "AI Summary" %}</h5>
                    </div>
                    <div class="card-body">
                        <div id="ai-summary-loading-commodity" class="d-flex align-items-center" style="display:none;">
                            <div class="spinner-border text-warning me-3" role="status"></div>
                            <div>
                                <div id="ai-summary-status-commodity" class="fw-semibold">{% trans "Preparing analysis..." %}</div>
                                <small class="text-muted">{% trans "This may take up to 1 minute." %}</small>
                            </div>
                        </div>
                        <div id="ai-summary-content-commodity" style="display:none;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        
        <!-- Commodity Price Chart JavaScript -->
        {% if is_commodity and prices %}
        <script>
        // Commodity Price Chart Data
        const commodityPriceData = [
        {% for price in prices %}
            {% if price.price %}
            {
                x: '{{ price.date|date:"Y-m-d" }}',
                y: {{ price.price|floatformat:2 }}
            }{% if not forloop.last %},{% endif %}
            {% endif %}
        {% endfor %}
        ].reverse();

        // Initialize commodity chart function
        function initializeCommodityChart() {
            const chartElement = document.getElementById('commodityPriceChart');
            if (!chartElement) {
                console.error('Commodity chart element not found');
                return;
            }
            
            console.log('Commodity chart data:', commodityPriceData);
            console.log('Commodity chart labels:', commodityLabels);
            console.log('Commodity chart data length:', commodityPriceData.length);
            
            if (commodityPriceData.length === 0) {
                chartElement.innerHTML = '<p class="text-center text-muted">{% trans "No price data available" %}</p>';
                return;
            }

            const ctx = chartElement.getContext('2d');
            
            // Ensure Chart.js is loaded and we have data
            if (typeof Chart !== 'undefined' && commodityPriceData.length > 0) {
                try {
                    console.log('Creating commodity chart with data:', commodityPriceData);
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            datasets: [{
                                label: '{{ symbol }}',
                                data: commodityPriceData,
                                borderColor: '#ffc107',
                                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                tension: 0.1,
                                fill: true,
                                pointRadius: 2,
                                pointHoverRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        parser: 'yyyy-MM-dd',
                                        displayFormats: {
                                            day: 'MMM dd',
                                            week: 'MMM dd',
                                            month: 'MMM yyyy',
                                            quarter: 'MMM yyyy',
                                            year: 'yyyy'
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: ''
                                    },
                                    ticks: {
                                        maxTicksLimit: 8,
                                        maxRotation: 45,
                                        minRotation: 0
                                    }
                                },
                                y: {
                                    beginAtZero: false,
                                    title: {
                                        display: true,
                                        text: ''
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return '$' + value.toFixed(2);
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            return '{{ symbol }}: $' + context.parsed.y.toFixed(2);
                                        }
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    chartElement.innerHTML = '<p class="text-center text-danger">{% trans "Chart creation failed" %}</p>';
                }
            } else {
                if (typeof Chart === 'undefined') {
                    chartElement.innerHTML = '<p class="text-center text-muted">{% trans "Chart library not loaded" %}</p>';
                }
            }
        }

        // Initialize chart when page is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeCommodityChart);
        } else {
            initializeCommodityChart();
        }
        </script>
        {% endif %}
        
        {% elif is_cryptocurrency and cryptocurrency %}
        <!-- Cryptocurrency Information Display -->
        <h1 class="mb-4">
            {{ symbol }} - {{ cryptocurrency.name }}
            <span class="badge bg-warning text-dark ms-2">Cryptocurrency</span>
        </h1>
        
        <!-- Cryptocurrency Information -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-coins me-2"></i>{% trans "Cryptocurrency Information" %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>{% trans "Symbol" %}:</strong> {{ symbol }}</p>
                                <p><strong>{% trans "Name" %}:</strong> {{ cryptocurrency.name }}</p>
                                <p><strong>{% trans "Currency" %}:</strong> {{ cryptocurrency.currency }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>{% trans "Type" %}:</strong> {% trans "Cryptocurrency" %}</p>
                                {% if cryptocurrency.market_cap %}
                                <p><strong>{% trans "Market Cap" %}:</strong> {{ cryptocurrency.market_cap_formatted }}</p>
                                {% endif %}
                                {% if cryptocurrency.circulating_supply %}
                                <p><strong>{% trans "Circulating Supply" %}:</strong> {{ cryptocurrency.circulating_supply|floatformat:0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>{% trans "Quick Actions" %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="{% url 'compare_symbols' symbols=symbol %}" class="btn btn-primary">
                                <i class="fas fa-balance-scale me-2"></i>{% trans "Compare" %}
                            </a>
                            <a href="{% url 'portfolio:form' %}" class="btn btn-success">
                                <i class="fas fa-plus me-2"></i>{% trans "Add to Portfolio" %}
                            </a>
                            {% if user.is_authenticated %}
                                <button class="btn btn-outline-secondary" onclick="saveSymbol('{{ symbol }}')">
                                    <i class="fas fa-bookmark me-2"></i>{% trans "Save" %}
                                </button>
                            {% endif %}
                            <button class="ai-summary-btn btn btn-warning text-dark" data-symbol="{{ symbol }}">
                                <i class="fas fa-robot me-2"></i>{% trans "AI Summary" %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Price Chart -->
        {% if prices and is_cryptocurrency %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>{% trans "Price Chart" %} ({{ currency_symbol }})
                        </h5>
                        <!-- Period Switch -->
                        <div class="btn-group" role="group" aria-label="{% trans 'Chart Period' %}">
                            <input type="radio" class="btn-check" name="chartPeriod" id="period1M" value="1M" {% if period == '1M' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period1M">1M</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period3M" value="3M" {% if period == '3M' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period3M">3M</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period6M" value="6M" {% if period == '6M' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period6M">6M</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="periodYTD" value="YTD" {% if period == 'YTD' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="periodYTD">YTD</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period1Y" value="1Y" {% if period == '1Y' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period1Y">1Y</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period3Y" value="3Y" {% if period == '3Y' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period3Y">3Y</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period5Y" value="5Y" {% if period == '5Y' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period5Y">5Y</label>
                            
                                <input type="radio" class="btn-check" name="chartPeriod" id="period10Y" value="10Y" {% if period == '10Y' %}checked{% endif %}>
                                <label class="btn btn-outline-secondary btn-sm" for="period10Y">10Y</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div style="height: 400px;">
                            <canvas id="cryptocurrencyPriceChart"></canvas>
                        </div>
                        {% if prices|length == 0 %}
                            <p class="text-muted text-center mt-3">{% trans "No price data available" %}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    {% trans "Price data is not available for this cryptocurrency. This could be due to:" %}
                    <ul class="mb-0 mt-2">
                        <li>{% trans "Cryptocurrency symbol not found in the database" %}</li>
                        <li>{% trans "No price data loaded for this cryptocurrency" %}</li>
                        <li>{% trans "API key not configured" %}</li>
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- AI Summary Result Placeholder - Always render -->
        <div id="ai-summary-card-crypto" class="row" style="display:none;">
            <div class="col-12">
                <div class="card mt-3">
                    <div class="card-header d-flex align-items-center">
                        <i class="fas fa-robot me-2"></i>
                        <h5 class="mb-0">{% trans "AI Summary" %}</h5>
                    </div>
                    <div class="card-body">
                        <div id="ai-summary-loading-crypto" class="d-flex align-items-center" style="display:none;">
                            <div class="spinner-border text-warning me-3" role="status"></div>
                            <div>
                                <div id="ai-summary-status-crypto" class="fw-semibold">{% trans "Preparing analysis..." %}</div>
                                <small class="text-muted">{% trans "This may take up to 1 minute." %}</small>
                            </div>
                        </div>
                        <div id="ai-summary-content-crypto" style="display:none;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        
        <!-- Cryptocurrency Price Chart JavaScript -->
        {% if is_cryptocurrency and prices %}
        <script>
        // Cryptocurrency Price Chart Data
        const cryptocurrencyPriceData = [
        {% for price in prices %}
            {% if price.close_price and price.close_price != None %}
            {
                x: '{{ price.date|date:"Y-m-d" }}',
                y: {{ price.close_price|floatformat:2 }}
            }{% if not forloop.last %},{% endif %}
            {% endif %}
        {% endfor %}
        ].reverse();

        // Currency symbol for chart formatting
        const cryptoCurrencySymbol = '$';

        // Initialize cryptocurrency chart function
        function initializeCryptocurrencyChart() {
            const chartElement = document.getElementById('cryptocurrencyPriceChart');
            if (!chartElement) {
                return; // Chart element doesn't exist on this page
            }
            
            if (cryptocurrencyPriceData.length === 0) {
                chartElement.innerHTML = '<p class="text-center text-muted">{% trans "No price data available" %}</p>';
                return;
            }

            const ctx = chartElement.getContext('2d');
            
            // Ensure Chart.js is loaded and we have data
            if (typeof Chart !== 'undefined' && cryptocurrencyPriceData.length > 0) {
                try {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            datasets: [{
                                label: '{{ symbol }}',
                                data: cryptocurrencyPriceData,
                                borderColor: '#ffc107',
                                backgroundColor: 'rgba(255, 193, 7, 0.1)',
                                tension: 0.1,
                                fill: true,
                                pointRadius: 2,
                                pointHoverRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            },
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        parser: 'yyyy-MM-dd',
                                        displayFormats: {
                                            day: 'MMM dd',
                                            week: 'MMM dd',
                                            month: 'MMM yyyy',
                                            quarter: 'MMM yyyy',
                                            year: 'yyyy'
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: ''
                                    },
                                    ticks: {
                                        maxTicksLimit: 8,
                                        maxRotation: 45,
                                        minRotation: 0
                                    }
                                },
                                y: {
                                    beginAtZero: false,
                                    title: {
                                        display: true,
                                        text: ''
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return cryptoCurrencySymbol + value.toFixed(2);
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            return '{{ symbol }}: ' + cryptoCurrencySymbol + context.parsed.y.toFixed(2);
                                        }
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    chartElement.innerHTML = '<p class="text-center text-danger">{% trans "Chart creation failed" %}</p>';
                }
            } else {
                if (typeof Chart === 'undefined') {
                    chartElement.innerHTML = '<p class="text-center text-muted">{% trans "Chart library not loaded" %}</p>';
                }
            }
        }

        // Initialize chart when page is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeCryptocurrencyChart);
        } else {
            initializeCryptocurrencyChart();
        }
        </script>
        {% endif %}
        
        {% elif is_forex and quote %}
        <!-- Forex Information Display -->
        <h1 class="mb-4">
            {{ symbol }} - {{ quote.name }}
            <span class="badge bg-info text-white ms-2">Forex</span>
        </h1>
        
        <!-- Forex Information -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-exchange-alt me-2"></i>{% trans "Forex Information" %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>{% trans "Symbol" %}:</strong> {{ symbol }}</p>
                                <p><strong>{% trans "Name" %}:</strong> {{ quote.name }}</p>
                                <p><strong>{% trans "Exchange" %}:</strong> {{ quote.exchange }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>{% trans "Type" %}:</strong> {% trans "Foreign Exchange" %}</p>
                                <p><strong>{% trans "Currency" %}:</strong> {{ quote.currency }}</p>
                                {% if quote.volume %}
                                <p><strong>{% trans "Volume" %}:</strong> {{ quote.volume|floatformat:0 }}</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Forex Quote Card -->
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>{% trans "Current Quote" %}
                        </h5>
                    </div>
                    <div class="card-body text-center">
                        {% if quote.price %}
                        <h3 class="mb-2">
                            {{ quote.price|floatformat:6 }}
                        </h3>
                        {% if quote.changePercentage %}
                        <p class="mb-1">
                            <span class="badge {% if quote.changePercentage >= 0 %}bg-success{% else %}bg-danger{% endif %}">
                                {% if quote.changePercentage >= 0 %}+{% endif %}{{ quote.changePercentage|floatformat:2 }}%
                            </span>
                        </p>
                        {% endif %}
                        {% if quote.change %}
                        <p class="mb-1">
                            <small class="text-muted">
                                {% if quote.change >= 0 %}+{% endif %}{{ quote.change|floatformat:6 }}
                            </small>
                        </p>
                        {% endif %}
                        {% if quote.dayHigh and quote.dayLow %}
                        <div class="mt-3">
                            <small class="text-muted d-block">{% trans "Day Range" %}</small>
                            <small class="text-success">{{ quote.dayHigh|floatformat:6 }}</small>
                            <span class="text-muted mx-1">-</span>
                            <small class="text-danger">{{ quote.dayLow|floatformat:6 }}</small>
                        </div>
                        {% endif %}
                        {% else %}
                        <p class="text-muted">{% trans "Quote data not available" %}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Forex Price Chart -->
        {% if prices and is_forex %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>{% trans "Price Chart" %} ({{ currency_symbol }})
                        </h5>
                        <!-- Period Switch -->
                        <div class="btn-group" role="group" aria-label="{% trans 'Chart Period' %}">
                            <input type="radio" class="btn-check" name="chartPeriod" id="period1M" value="1M" {% if period == '1M' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period1M">1M</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period3M" value="3M" {% if period == '3M' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period3M">3M</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period6M" value="6M" {% if period == '6M' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period6M">6M</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="periodYTD" value="YTD" {% if period == 'YTD' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="periodYTD">YTD</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period1Y" value="1Y" {% if period == '1Y' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period1Y">1Y</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period3Y" value="3Y" {% if period == '3Y' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period3Y">3Y</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period5Y" value="5Y" {% if period == '5Y' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period5Y">5Y</label>
                            
                                <input type="radio" class="btn-check" name="chartPeriod" id="period10Y" value="10Y" {% if period == '10Y' %}checked{% endif %}>
                                <label class="btn btn-outline-secondary btn-sm" for="period10Y">10Y</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="forexPriceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>{% trans "No Price Data Available" %}</strong>
                    <p class="mb-0 mt-2">{% trans "Price data is not available for this forex pair. This could be due to:" %}</p>
                    <ul class="mb-0 mt-2">
                        <li>{% trans "Forex pair not found in the database" %}</li>
                        <li>{% trans "No price data loaded for this forex pair" %}</li>
                        <li>{% trans "API key not configured" %}</li>
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Forex Price Chart JavaScript -->
        {% if is_forex and prices %}
        <script>
        // Forex Price Chart Data
        const forexPriceData = [
        {% for price in prices %}
            {% if price.price %}
            {
                x: '{{ price.date|date:"Y-m-d" }}',
                y: {{ price.price|floatformat:6 }}
            }{% if not forloop.last %},{% endif %}
            {% endif %}
        {% endfor %}
        ].reverse();

        // Initialize forex chart function
        function initializeForexChart() {
            const chartElement = document.getElementById('forexPriceChart');
            if (!chartElement) {
                return; // Chart element doesn't exist on this page
            }
            
            if (forexPriceData.length === 0) {
                chartElement.innerHTML = '<p class="text-center text-muted">{% trans "No price data available" %}</p>';
                return;
            }

            const ctx = chartElement.getContext('2d');
            
            // Ensure Chart.js is loaded and we have data
            if (typeof Chart !== 'undefined' && forexPriceData.length > 0) {
                try {
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            datasets: [{
                                label: '{{ symbol }}',
                                data: forexPriceData,
                                borderColor: '#17a2b8',
                                backgroundColor: 'rgba(23, 162, 184, 0.1)',
                                tension: 0.1,
                                fill: true,
                                pointRadius: 2,
                                pointHoverRadius: 4
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            scales: {
                                x: {
                                    type: 'time',
                                    time: {
                                        parser: 'yyyy-MM-dd',
                                        displayFormats: {
                                            day: 'MMM dd',
                                            week: 'MMM dd',
                                            month: 'MMM yyyy',
                                            quarter: 'MMM yyyy',
                                            year: 'yyyy'
                                        }
                                    },
                                    title: {
                                        display: true,
                                        text: ''
                                    },
                                    ticks: {
                                        maxTicksLimit: 8,
                                        maxRotation: 45,
                                        minRotation: 0
                                    }
                                },
                                y: {
                                    beginAtZero: false,
                                    title: {
                                        display: true,
                                        text: ''
                                    },
                                    ticks: {
                                        callback: function(value) {
                                            return value.toFixed(6);
                                        }
                                    }
                                }
                            },
                            plugins: {
                                legend: {
                                    display: true
                                },
                                tooltip: {
                                    mode: 'index',
                                    intersect: false,
                                    callbacks: {
                                        label: function(context) {
                                            return '{{ symbol }}: ' + context.parsed.y.toFixed(6);
                                        }
                                    }
                                }
                            }
                        }
                    });
                } catch (error) {
                    chartElement.innerHTML = '<p class="text-center text-danger">{% trans "Chart creation failed" %}</p>';
                }
            } else {
                if (typeof Chart === 'undefined') {
                    chartElement.innerHTML = '<p class="text-center text-muted">{% trans "Chart library not loaded" %}</p>';
                }
            }
        }

        // Initialize chart when page is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeForexChart);
        } else {
            initializeForexChart();
        }
        </script>
        {% endif %}
        
        <!-- AI Summary Result Placeholder - Always render -->
        <div id="ai-summary-card-forex" class="row" style="display:none;">
            <div class="col-12">
                <div class="card mt-3">
                    <div class="card-header d-flex align-items-center">
                        <i class="fas fa-robot me-2"></i>
                        <h5 class="mb-0">{% trans "AI Summary" %}</h5>
                    </div>
                    <div class="card-body">
                        <div id="ai-summary-loading-forex" class="d-flex align-items-center" style="display:none;">
                            <div class="spinner-border text-warning me-3" role="status"></div>
                            <div>
                                <div id="ai-summary-status-forex" class="fw-semibold">{% trans "Preparing analysis..." %}</div>
                                <small class="text-muted">{% trans "This may take up to 1 minute." %}</small>
                            </div>
                        </div>
                        <div id="ai-summary-content-forex" style="display:none;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        {% else %}
        <h1 class="mb-4">
            {{ symbol }} - {{ instrument.name }}
            {% if instrument.exchange %}
                <small class="text-muted">({{ instrument.exchange }})</small>
            {% endif %}
        </h1>
        
        <!-- Company Information -->
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-building me-2"></i>{% trans "Company Information" %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>{% trans "Sector" %}:</strong> {{ instrument.sector|default:"N/A" }}</p>
                                <p><strong>{% trans "Industry" %}:</strong> {{ instrument.industry|default:"N/A" }}</p>
                                <p><strong>{% trans "Currency" %}:</strong> {{ instrument.currency }}</p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>{% trans "Market Cap" %}:</strong> 
                                    {{ instrument.market_cap_formatted|default:"N/A" }}
                                </p>
                                <p><strong>{% trans "Status" %}:</strong> 
                                    <span class="badge bg-{% if instrument.is_active %}success{% else %}danger{% endif %}">
                                        {% if instrument.is_active %}{% trans "Active" %}{% else %}{% trans "Inactive" %}{% endif %}
                                    </span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>{% trans "Quick Actions" %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <a href="{% url 'compare_symbols' symbols=symbol %}" class="btn btn-primary">
                                <i class="fas fa-balance-scale me-2"></i>{% trans "Compare" %}
                            </a>
                            <a href="{% url 'portfolio:form' %}" class="btn btn-success">
                                <i class="fas fa-plus me-2"></i>{% trans "Add to Portfolio" %}
                            </a>
                            {% if user.is_authenticated %}
                                <button class="btn btn-outline-secondary" onclick="saveSymbol('{{ symbol }}')">
                                    <i class="fas fa-bookmark me-2"></i>{% trans "Save" %}
                                </button>
                            {% endif %}
                            <button class="ai-summary-btn btn btn-warning text-dark" data-symbol="{{ symbol }}">
                                <i class="fas fa-robot me-2"></i>{% trans "AI Summary" %}
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fundamentals -->
        {% if fundamentals %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-calculator me-2"></i>{% trans "Fundamental Metrics" %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-2">
                                <div class="text-center">
                                    <h6>{{ fundamentals.pe_ratio|floatformat:2|default:"N/A" }}</h6>
                                    <p class="text-muted">{% trans "P/E Ratio" %}</p>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center">
                                    <h6>{{ fundamentals.pb_ratio|floatformat:2|default:"N/A" }}</h6>
                                    <p class="text-muted">{% trans "P/B Ratio" %}</p>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center">
                                    <h6>{{ fundamentals.debt_to_equity|floatformat:2|default:"N/A" }}</h6>
                                    <p class="text-muted">{% trans "Debt/Equity" %}</p>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center">
                                    <h6>{{ fundamentals.roe|floatformat:2|default:"N/A" }}</h6>
                                    <p class="text-muted">{% trans "ROE" %}</p>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center">
                                    <h6>{{ fundamentals.roa|floatformat:2|default:"N/A" }}</h6>
                                    <p class="text-muted">{% trans "ROA" %}</p>
                                </div>
                            </div>
                            <div class="col-md-2">
                                <div class="text-center">
                                    <h6>{{ fundamentals.current_ratio|floatformat:2|default:"N/A" }}</h6>
                                    <p class="text-muted">{% trans "Current Ratio" %}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Price Chart -->
        {% if prices and is_stock %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-area me-2"></i>{% trans "Price Chart" %} ({{ currency_symbol }})
                        </h5>
                        <!-- Period Switch -->
                        <div class="btn-group" role="group" aria-label="{% trans 'Chart Period' %}">
                            <input type="radio" class="btn-check" name="chartPeriod" id="period1M" value="1M" {% if period == '1M' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period1M">1M</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period3M" value="3M" {% if period == '3M' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period3M">3M</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period6M" value="6M" {% if period == '6M' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period6M">6M</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="periodYTD" value="YTD" {% if period == 'YTD' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="periodYTD">YTD</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period1Y" value="1Y" {% if period == '1Y' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period1Y">1Y</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period3Y" value="3Y" {% if period == '3Y' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period3Y">3Y</label>
                            
                            <input type="radio" class="btn-check" name="chartPeriod" id="period5Y" value="5Y" {% if period == '5Y' %}checked{% endif %}>
                            <label class="btn btn-outline-secondary btn-sm" for="period5Y">5Y</label>
                            
                                <input type="radio" class="btn-check" name="chartPeriod" id="period10Y" value="10Y" {% if period == '10Y' %}checked{% endif %}>
                                <label class="btn btn-outline-secondary btn-sm" for="period10Y">10Y</label>
                        </div>
                    </div>
                    <div class="card-body">
                        <div style="height: 400px;">
                            <canvas id="priceChart"></canvas>
                        </div>
                        {% if prices|length == 0 %}
                            <p class="text-muted text-center mt-3">{% trans "No price data available" %}</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% else %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    {% trans "Price data is not available for this symbol. This could be due to:" %}
                    <ul class="mb-0 mt-2">
                        <li>{% trans "Symbol not found in the database" %}</li>
                        <li>{% trans "No price data loaded for this instrument" %}</li>
                        <li>{% trans "API key not configured" %}</li>
                    </ul>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- Performance Metrics -->
        {% if metrics %}
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-chart-bar me-2"></i>{% trans "Performance Metrics" %}
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-primary">{{ metrics.cagr|mul:100|floatformat:2 }}%</h4>
                                    <p class="text-muted">{% trans "CAGR" %}</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-info">{{ metrics.volatility|mul:100|floatformat:2 }}%</h4>
                                    <p class="text-muted">{% trans "Volatility" %}</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-success">{{ metrics.sharpe_ratio|floatformat:2 }}</h4>
                                    <p class="text-muted">{% trans "Sharpe Ratio" %}</p>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h4 class="text-warning">{{ metrics.max_drawdown|mul:100|floatformat:2 }}%</h4>
                                    <p class="text-muted">{% trans "Max Drawdown" %}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}
        
        <!-- AI Summary Result Placeholder - Always render -->
        <div id="ai-summary-card-stock" class="row" style="display:none;">
            <div class="col-12">
                <div class="card mt-3">
                    <div class="card-header d-flex align-items-center">
                        <i class="fas fa-robot me-2"></i>
                        <h5 class="mb-0">{% trans "AI Summary" %}</h5>
                    </div>
                    <div class="card-body">
                        <div id="ai-summary-loading-stock" class="d-flex align-items-center" style="display:none;">
                            <div class="spinner-border text-warning me-3" role="status"></div>
                            <div>
                                <div id="ai-summary-status-stock" class="fw-semibold">{% trans "Preparing analysis..." %}</div>
                                <small class="text-muted">{% trans "This may take up to 1 minute." %}</small>
                            </div>
                        </div>
                        <div id="ai-summary-content-stock" style="display:none;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
{% if show_search_form %}
<script>
// Dynamic search form behavior
document.addEventListener('DOMContentLoaded', function() {
    const searchTypeSelect = document.querySelector('select[name="search_type"]');
    const searchInput = document.getElementById('search-input');
    const symbolExample = document.querySelector('.symbol-example');
    const companyExample = document.querySelector('.company-example');
    const isinExample = document.querySelector('.isin-example');
    const etfExample = document.querySelector('.etf-example');
    const commodityExample = document.querySelector('.commodity-example');
    const cryptocurrencyExample = document.querySelector('.cryptocurrency-example');
    const forexExample = document.querySelector('.forex-example');
    
    function updateSearchForm() {
        const searchType = searchTypeSelect.value;
        
        // Update placeholder
        switch(searchType) {
            case 'symbol':
                searchInput.placeholder = '{% trans "Enter stock symbol (e.g., AAPL, MSFT, GOOGL, TSLA)" %}';
                break;
            case 'company':
                searchInput.placeholder = '{% trans "Enter company name (e.g., Gazprom, Apple Inc, Microsoft)" %}';
                break;
            case 'isin':
                searchInput.placeholder = '{% trans "Enter ISIN (e.g., US0378331005 for Apple)" %}';
                break;
            case 'etf':
                searchInput.placeholder = '{% trans "Enter ETF symbol or name (e.g., SPY, VTI, QQQ, ARKK)" %}';
                break;
            case 'commodity':
                searchInput.placeholder = '{% trans "Enter commodity symbol (e.g., GCUSD, SILUSD, CLUSD)" %}';
                break;
            case 'cryptocurrency':
                searchInput.placeholder = '{% trans "Enter cryptocurrency symbol (e.g., BTCUSD, ETHUSD, ADAUSD)" %}';
                break;
            case 'forex':
                searchInput.placeholder = '{% trans "Enter forex pair symbol (e.g., EURUSD, GBPUSD, USDJPY)" %}';
                break;
        }
        
        // Update examples visibility
        symbolExample.style.display = searchType === 'symbol' ? 'inline' : 'none';
        companyExample.style.display = searchType === 'company' ? 'inline' : 'none';
        isinExample.style.display = searchType === 'isin' ? 'inline' : 'none';
        etfExample.style.display = searchType === 'etf' ? 'inline' : 'none';
        commodityExample.style.display = searchType === 'commodity' ? 'inline' : 'none';
        cryptocurrencyExample.style.display = searchType === 'cryptocurrency' ? 'inline' : 'none';
        forexExample.style.display = searchType === 'forex' ? 'inline' : 'none';
    }
    
    // Initial setup
    updateSearchForm();
    
    // Update on change
    searchTypeSelect.addEventListener('change', updateSearchForm);
});
</script>
{% endif %}

{% if prices and not is_cryptocurrency %}
<script>
// Price Chart Data
const priceData = [
{% for price in prices %}
    {
        x: '{{ price.date|date:"Y-m-d" }}',
        y: {{ price.close_price|floatformat:2 }}
    }{% if not forloop.last %},{% endif %}
{% endfor %}
].reverse();

// Currency symbol for chart formatting
const currencySymbol = '{{ instrument.currency_symbol }}';

// Initialize chart function
function initializeChart() {
    const chartElement = document.getElementById('priceChart');
    if (!chartElement) {
        return; // Chart element doesn't exist on this page
    }
    
    if (priceData.length === 0) {
        chartElement.innerHTML = '<p class="text-center text-muted">{% trans "No price data available" %}</p>';
        return;
    }

    const ctx = chartElement.getContext('2d');
    
    // Ensure Chart.js is loaded and we have data
    if (typeof Chart !== 'undefined' && priceData.length > 0) {
        try {
            new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label: '{{ symbol }}',
                        data: priceData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1,
                        fill: true,
                        pointRadius: 2,
                        pointHoverRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                parser: 'yyyy-MM-dd',
                                displayFormats: {
                                    day: 'MMM dd',
                                    week: 'MMM dd',
                                    month: 'MMM yyyy',
                                    quarter: 'MMM yyyy',
                                    year: 'yyyy'
                                }
                            },
                            title: {
                                display: true,
                                text: ''
                            },
                            ticks: {
                                maxTicksLimit: 8,
                                maxRotation: 45,
                                minRotation: 0
                            }
                        },
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: ''
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            mode: 'index',
                            intersect: false,
                            callbacks: {
                                label: function(context) {
                                    return '{{ symbol }}: ' + currencySymbol + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    }
                }
            });
        } catch (error) {
            chartElement.innerHTML = '<p class="text-center text-danger">{% trans "Chart creation failed" %}</p>';
        }
    } else {
        if (typeof Chart === 'undefined') {
            chartElement.innerHTML = '<p class="text-center text-muted">{% trans "Chart library not loaded" %}</p>';
        }
    }
}

// Initialize chart when page is loaded
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeChart);
} else {
    initializeChart();
}
</script>
{% endif %}

<script>
(function(){
  function startAISummary(symbol){
    // Determine which AI summary card to use based on the current page context
    let cardId, loadingId, contentId, statusId;
    
    // Check if we're on a commodity page
    if (document.querySelector('#commodityPriceChart')) {
      cardId = 'ai-summary-card-commodity';
      loadingId = 'ai-summary-loading-commodity';
      contentId = 'ai-summary-content-commodity';
      statusId = 'ai-summary-status-commodity';
    }
    // Check if we're on a cryptocurrency page
    else if (document.querySelector('#cryptocurrencyPriceChart')) {
      cardId = 'ai-summary-card-crypto';
      loadingId = 'ai-summary-loading-crypto';
      contentId = 'ai-summary-content-crypto';
      statusId = 'ai-summary-status-crypto';
    }
    // Check if we're on a forex page
    else if (document.querySelector('#forexPriceChart')) {
      cardId = 'ai-summary-card-forex';
      loadingId = 'ai-summary-loading-forex';
      contentId = 'ai-summary-content-forex';
      statusId = 'ai-summary-status-forex';
    }
    // Default to stock
    else {
      cardId = 'ai-summary-card-stock';
      loadingId = 'ai-summary-loading-stock';
      contentId = 'ai-summary-content-stock';
      statusId = 'ai-summary-status-stock';
    }
    
    console.log('Using AI summary elements:', {cardId, loadingId, contentId, statusId});
    
    const card = document.getElementById(cardId);
    const loading = document.getElementById(loadingId);
    const content = document.getElementById(contentId);
    const statusEl = document.getElementById(statusId);
    
    console.log('Found elements:', {card, loading, content, statusEl});
    
    if (card) {
      card.style.display = 'block';
      // Scroll to the AI summary block
      card.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    if (content) { content.style.display = 'none'; content.innerHTML=''; }

    // Try cached summary first - don't show loading spinner yet
    fetch('/api/v1/ai/summary/' + encodeURIComponent(symbol))
      .then(function(r){ 
        console.log('Cache fetch response:', r.status);
        if(r.ok) return r.json(); 
        throw new Error('no-cache'); 
      })
      .then(function(result){
        console.log('Cache result:', result);
        if(result && result.summary){
          // Data loaded from cache - show content directly without loading spinner
          console.log('Cached data found, showing content directly');
          if(loading) {
            console.log('Hiding loading element completely');
            loading.style.display = 'none';
            loading.style.visibility = 'hidden';
          }
          if(content){ 
            console.log('Showing content');
            content.style.display = 'block'; 
            content.innerHTML = renderAISummary(result.summary); 
          }
        } else {
          console.log('No summary in result, showing loading spinner');
          throw new Error('no-cache');
        }
      })
      .catch(function(error){
        console.log('Cache fetch failed:', error);
        console.log('No cached data, showing loading spinner and starting background job');
        
        // Only show loading spinner if no cached data
        if(loading) {
          loading.style.display = 'flex';
          loading.style.visibility = 'visible';
        }
        if(statusEl) statusEl.textContent = 'Preparing analysis...';
        
        // Start background job
        fetch('/api/v1/ai/summary/start?symbol=' + encodeURIComponent(symbol), {method: 'POST'})
          .then(function(r){ return r.json(); })
          .then(function(body){
            if(!body.job_id){ throw new Error('no job'); }
            pollStatus(body.job_id, symbol, statusEl, loading, content);
          })
          .catch(function(){
            if(statusEl) statusEl.textContent = '{{ _('Failed to start AI analysis') }}';
          });
      });
  }

  function pollStatus(jobId, symbol, statusEl, loading, content){
    var messages = [
      '{{ _('Identifying asset...') }}',
      '{{ _('Fetching market data...') }}',
      '{{ _('Computing metrics...') }}',
      '{{ _('Summarizing with AI...') }}'
    ];
    var i = 0;
    var interval = setInterval(function(){
      fetch('/api/v1/ai/summary/status?job_id=' + encodeURIComponent(jobId) + '&symbol=' + encodeURIComponent(symbol))
        .then(function(r){ return r.json(); })
        .then(function(body){
          if(body.status === 'completed' && body.result){
            clearInterval(interval);
            // Hide loading spinner completely when analysis is complete
            if(loading) {
              loading.style.display = 'none';
              loading.style.visibility = 'hidden';
            }
            if(content){ content.style.display = 'block'; content.innerHTML = renderAISummary(body.result.summary || ''); }
          } else if(body.status === 'completed' && !body.result) {
            // Try to fetch the cached result explicitly (race condition fallback)
            fetch('/api/v1/ai/summary/' + encodeURIComponent(symbol))
              .then(function(r){ if(r.ok) return r.json(); throw new Error('no-cache'); })
              .then(function(res){
                clearInterval(interval);
                // Hide loading spinner completely when analysis is complete
                if(loading) {
                  loading.style.display = 'none';
                  loading.style.visibility = 'hidden';
                }
                if(content){ content.style.display = 'block'; content.innerHTML = renderAISummary(res.summary || ''); }
              })
              .catch(function(){
                if(statusEl) statusEl.textContent = '{{ _('AI analysis failed. Please try again later.') }}';
                clearInterval(interval);
              });
          } else if(body.status === 'failed') {
            clearInterval(interval);
            if(statusEl) statusEl.textContent = '{{ _('AI analysis failed. Please try again later.') }}';
          } else {
            if(statusEl){ statusEl.textContent = messages[i % messages.length]; i++; }
          }
        })
        .catch(function(){ /* ignore transient errors */ });
    }, 1200);
  }

  function renderAISummary(text){
    // Basic formatting with simple bold headers
    var safe = (text || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    
    // Split into sections based on ### headers
    var sections = safe.split(/(?=### )/);
    var formattedSections = sections.map(function(section) {
      if (!section.trim()) return '';
      
      var lines = section.trim().split('\n');
      var header = '';
      var content = '';
      
      // Check if first line is a header (starts with ###)
      if (lines[0] && lines[0].startsWith('### ')) {
        header = lines[0].replace('### ', '');
        content = lines.slice(1).join('\n').trim();
      } else {
        content = section.trim();
      }
      
      var result = '';
      
      // Add simple bold header if present
      if (header) {
        result += '<div class="mb-3">';
        result += '<strong>' + header + '</strong>';
        result += '</div>';
      }
      
      // Format content with proper paragraphs
      if (content) {
        var paragraphs = content.split(/\n{2,}/);
        paragraphs.forEach(function(para) {
          if (para.trim()) {
            // Check for bold text (**text**)
            para = para.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            // Convert single line breaks to <br> within paragraphs
            para = para.replace(/\n/g, '<br>');
            result += '<p class="mb-3">' + para + '</p>';
          }
        });
      }
      
      return result;
    });
    
    return '<div class="ai-summary-formatted">' + formattedSections.join('') + '</div>';
  }

  // Attach click handlers to AI summary buttons
  function attachAISummaryHandlers() {
    var buttons = document.querySelectorAll('.ai-summary-btn');
    buttons.forEach(function(btn){
      btn.onclick = function() {
        var symbol = this.getAttribute('data-symbol');
        startAISummary(symbol);
      };
    });
  }
  
  // Try multiple ways to attach handlers
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', attachAISummaryHandlers);
  } else {
    attachAISummaryHandlers();
  }
  
  // Also try after a short delay
  setTimeout(attachAISummaryHandlers, 100);
})();
</script>

{% if user.is_authenticated %}
<script>
function saveSymbol(symbol) {
    // Implementation for saving symbol to user's saved sets
    alert('{% trans "Symbol saved to your collection!" %}');
}
</script>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
.metric-card {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 0.5rem;
    margin-bottom: 1rem;
    border-left: 4px solid #007bff;
}

.metric-label {
    font-size: 0.875rem;
    color: #6c757d;
    font-weight: 500;
    margin-bottom: 0.25rem;
}

.metric-value {
    font-weight: 600;
    margin: 0;
}

.commodity-info .badge {
    font-size: 0.875rem;
}

.commodity-quote-info .metric-card {
    transition: box-shadow 0.2s ease-in-out;
}

.commodity-quote-info .metric-card:hover {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

@media (max-width: 768px) {
    .commodity-quote-info .col-md-4 {
        margin-top: 1rem;
    }
    
    .commodity-quote-info .metric-card {
        margin-bottom: 0.5rem;
    }
}

/* AI Summary Styling */
.ai-summary-formatted {
    line-height: 1.6;
}
</style>

<script>
// Period Switch Functionality
document.addEventListener('DOMContentLoaded', function() {
    const periodButtons = document.querySelectorAll('input[name="chartPeriod"]');
    
    periodButtons.forEach(function(button) {
        button.addEventListener('change', function() {
            if (this.checked) {
                const selectedPeriod = this.value;
                const currentUrl = new URL(window.location);
                currentUrl.searchParams.set('period', selectedPeriod);
                
                // Add loading state
                const chartContainers = document.querySelectorAll('[id$="Chart"]');
                chartContainers.forEach(function(container) {
                    if (container.tagName === 'CANVAS') {
                        const parent = container.parentElement;
                        parent.innerHTML = '<div class="d-flex justify-content-center align-items-center" style="height: 400px;"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div></div>';
                    }
                });
                
                // Reload page with new period
                window.location.href = currentUrl.toString();
            }
        });
    });
});
</script>
{% endblock %}
